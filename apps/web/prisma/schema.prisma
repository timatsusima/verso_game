generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  telegramId String   @unique
  username   String?
  firstName  String
  lastName   String?
  photoUrl   String?
  language   String   @default("en") // "ru" | "en"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  createdDuels      Duel[]                  @relation("DuelCreator")
  joinedDuels       Duel[]                  @relation("DuelOpponent")
  wonDuels          Duel[]                  @relation("DuelWinner")
  answers           DuelAnswer[]
  rating            UserRating?
  dailyDuelCounters UserDailyDuelCounter[]

  @@index([telegramId])
  @@index([createdAt])
}

model Duel {
  id             String    @id @default(cuid())
  topic          String
  questionsCount Int       @default(10)
  language       String    @default("en")
  difficulty     String    @default("medium") // easy, medium, hard
  status         String    @default("waiting") // waiting, pending, ready, in_progress, finished
  isRanked       Boolean   @default(false) // Ranked mode affects SR
  
  creatorId      String
  creator        User      @relation("DuelCreator", fields: [creatorId], references: [id])
  
  opponentId     String?
  opponent       User?     @relation("DuelOpponent", fields: [opponentId], references: [id])
  
  winnerId       String?
  winner         User?     @relation("DuelWinner", fields: [winnerId], references: [id])
  
  createdAt      DateTime  @default(now())
  startedAt      DateTime?
  finishedAt     DateTime?

  // Relations
  pack           DuelPack?
  answers        DuelAnswer[]
  matchResult    MatchResult?

  @@index([creatorId])
  @@index([opponentId])
  @@index([status])
  @@index([isRanked])
}

model DuelPack {
  id         String @id @default(cuid())
  duelId     String @unique
  duel       Duel   @relation(fields: [duelId], references: [id], onDelete: Cascade)
  
  // JSON string of QuestionWithAnswer[]
  questions  String @db.Text
  
  // For commit-reveal anti-cheat
  seed       String
  commitHash String

  createdAt  DateTime @default(now())
}

model DuelAnswer {
  id             String   @id @default(cuid())
  
  duelId         String
  duel           Duel     @relation(fields: [duelId], references: [id], onDelete: Cascade)
  
  playerId       String
  player         User     @relation(fields: [playerId], references: [id])
  
  questionIndex  Int
  answerIndex    Int?     // null = timeout/no answer
  isCorrect      Boolean
  responseTimeMs Int
  
  answeredAt     DateTime @default(now())

  @@unique([duelId, playerId, questionIndex])
  @@index([duelId])
  @@index([playerId])
}

// ============ Question Bank (Caching & Deduplication) ============

model QuestionBank {
  id             String    @id @default(cuid())
  
  // Normalized topic for matching (lowercase, trimmed)
  topicNorm      String
  subtopic       String?
  
  language       String    // "ru" | "en"
  difficulty     String    // "easy" | "medium" | "hard"
  
  // Question content
  questionText   String    @db.Text
  options        String    // JSON array of 4 options
  correctIndex   Int       // 0-3
  
  // Deduplication fingerprint (sha256 of normalized question + sorted options)
  fingerprint    String    @unique
  
  // Usage tracking
  timesServed    Int       @default(0)
  lastServedAt   DateTime?
  
  // Quality control (for future use)
  qualityScore   Float?
  isReported     Boolean   @default(false)
  isActive       Boolean   @default(true)
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([topicNorm, language, difficulty])
  @@index([fingerprint])
  @@index([lastServedAt])
  @@index([timesServed])
}

// ============ Skill Rating System ============

model UserRating {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sr           Int      @default(1000) // Skill Rating (0-30000)
  rd           Int      @default(350)  // Rating Deviation (80-350)
  gamesPlayed  Int      @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([sr])
  @@index([gamesPlayed])
}

model MatchResult {
  id              String   @id @default(cuid())
  duelId          String   @unique
  duel            Duel     @relation(fields: [duelId], references: [id], onDelete: Cascade)
  
  isRanked        Boolean  @default(false)
  topicNorm       String
  
  totalQuestions  Int
  
  // Creator stats
  creatorCorrectCount  Int
  creatorFasterCount   Int
  creatorSrBefore      Int
  creatorSrAfter       Int
  creatorDelta         Int
  
  // Opponent stats
  opponentCorrectCount Int
  opponentFasterCount  Int
  opponentSrBefore     Int
  opponentSrAfter      Int
  opponentDelta        Int
  
  createdAt       DateTime @default(now())

  @@index([duelId])
  @@index([isRanked])
  @@index([createdAt])
}

// ============ Analytics ============

model UserDailyDuelCounter {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  duelsPlayed Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}
